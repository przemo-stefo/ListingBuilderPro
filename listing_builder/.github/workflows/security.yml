# .github/workflows/security.yml
# Purpose: Automated security review on every PR using Claude Code Security
# NOT for: Runtime security scanning or dependency audits (use Dependabot for that)

name: Security Review

permissions:
  pull-requests: write
  contents: read

on:
  pull_request:

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 2

      - uses: anthropics/claude-code-action@beta
        with:
          use_claude_code_security: true
          claude_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          direct_prompt: |
            Review this PR for security vulnerabilities. Focus on:

            **Critical for this project (FastAPI + Next.js + Supabase):**
            - SQL injection (especially raw queries — we use SQLAlchemy, check for text() misuse)
            - SSRF (we have url_validator.py allowlist — changes there need extra scrutiny)
            - Auth bypass (JWT validation in middleware/supabase_auth.py, API key in middleware/auth.py)
            - XSS in Next.js frontend (unsanitized dangerouslySetInnerHTML, unescaped user input)
            - Hardcoded secrets (API keys, tokens, passwords in source code)
            - Insecure deserialization / eval() usage
            - Race conditions in async FastAPI endpoints
            - IDOR (missing ownership checks on resources)
            - Open redirects in OAuth callbacks
            - Missing CORS validation

            **Known safe patterns (DO NOT flag as issues):**
            - url_validator.py marketplace domain allowlist — this is intentional SSRF protection
            - Proxy route in frontend/src/app/api/proxy/[...path]/route.ts — server-side API key injection by design
            - PUBLIC_PATHS in middleware — /health, /docs, /stripe/webhook are intentionally public

            Rate each finding: CRITICAL / HIGH / MEDIUM / LOW
            For each finding, suggest a specific fix.
